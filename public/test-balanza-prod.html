<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Balanza - Producción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .weight-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .status-unstable {
            background-color: #ffc107;
        }
        .log-container {
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .log-error {
            color: #dc3545;
        }
        .log-success {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            Test Balanza - Producción
            <small class="text-muted fs-6">v1.0</small>
        </h1>

        <!-- Estado de Conexión -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Estado</h5>
                <div class="d-flex align-items-center">
                    <div class="status-indicator status-offline" id="connectionStatus"></div>
                    <span id="statusText">Desconectado</span>
                </div>
            </div>
        </div>

        <!-- Configuración -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Configuración</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="portSelect" class="form-label">Puerto COM</label>
                            <select class="form-select" id="portSelect">
                                <option value="COM1">COM1</option>
                                <option value="COM2">COM2</option>
                                <option value="COM3">COM3</option>
                                <option value="COM4">COM4</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="updateInterval" class="form-label">Intervalo de actualización (ms)</label>
                            <input type="number" class="form-control" id="updateInterval" value="1000" min="500" max="5000">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Control</label>
                            <div class="d-grid">
                                <button class="btn btn-primary" id="toggleConnection">Conectar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display de Peso -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Lectura Actual</h5>
                <div class="weight-display" id="weightDisplay">0.00 kg</div>
                <div class="row text-center">
                    <div class="col">
                        <span class="badge bg-secondary" id="stabilityBadge">Inestable</span>
                    </div>
                    <div class="col">
                        <span class="badge bg-secondary" id="validityBadge">No válido</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Log de Eventos -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Log de Eventos</h5>
                <div class="log-container" id="logContainer"></div>
            </div>
        </div>

        <!-- Diagnóstico -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Diagnóstico</h5>
                <div class="alert alert-info">
                    <h6>Lista de verificación:</h6>
                    <ol>
                        <li>Verificar que el servidor Python local esté ejecutándose:
                            <code>python servidor-balanza-local.py</code>
                        </li>
                        <li>Verificar que el puerto COM seleccionado sea el correcto</li>
                        <li>Verificar que la balanza esté encendida y conectada</li>
                        <li>Verificar que no haya otros programas usando el puerto COM</li>
                    </ol>
                </div>
                <div class="mt-3">
                    <button class="btn btn-info" id="testConnection">Probar Conexión</button>
                    <button class="btn btn-secondary ms-2" id="clearLog">Limpiar Log</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BalanceLogger {
            constructor(containerId, maxEntries = 100) {
                this.container = document.getElementById(containerId);
                this.maxEntries = maxEntries;
            }

            log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                this.container.insertBefore(entry, this.container.firstChild);
                
                // Limitar cantidad de entradas
                while (this.container.children.length > this.maxEntries) {
                    this.container.removeChild(this.container.lastChild);
                }
            }

            clear() {
                this.container.innerHTML = '';
            }
        }

        class BalanceController {
            constructor() {
                this.logger = new BalanceLogger('logContainer');
                this.isConnected = false;
                this.updateInterval = null;
                this.lastWeight = null;

                this.setupEventListeners();
                this.logger.log('Sistema iniciado');
            }

            async testConnection() {
                this.logger.log('Iniciando prueba de conexión...', 'info');
                
                // Construir URL completa
                const baseUrl = window.location.origin + '/balanceControl';
                this.logger.log(`URL base: ${baseUrl}`, 'info');
                
                try {
                    // 1. Probar conexión al gateway PHP
                    this.logger.log('1. Probando conexión al gateway...', 'info');
                    const port = document.getElementById('portSelect').value;
                    const gatewayUrl = `${baseUrl}/gateway-balanza.php?puerto=${port}`;
                    this.logger.log(`Intentando conexión a: ${gatewayUrl}`, 'info');
                    const response = await fetch(gatewayUrl);
                    
                    // Verificar tipo de contenido
                    const contentType = response.headers.get('content-type');
                    this.logger.log(`Tipo de contenido: ${contentType}`, 'info');
                    
                    // Intentar leer la respuesta como texto
                    const text = await response.text();
                    this.logger.log(`Respuesta recibida (primeros 100 caracteres): ${text.substring(0, 100)}`, 'info');
                    
                    // Intentar parsear como JSON
                    try {
                        const data = JSON.parse(text);
                        this.logger.log('Respuesta JSON válida', 'success');
                        if (data.success) {
                            this.logger.log('Conexión exitosa', 'success');
                        } else {
                            this.logger.log(`Error reportado: ${data.error}`, 'error');
                        }
                    } catch (e) {
                        this.logger.log('La respuesta no es JSON válido', 'error');
                    }
                    
                } catch (error) {
                    this.logger.log(`Error en prueba de conexión: ${error.message}`, 'error');
                }
            }

            setupEventListeners() {
                document.getElementById('toggleConnection').addEventListener('click', () => {
                    this.toggleConnection();
                });

                document.getElementById('updateInterval').addEventListener('change', (e) => {
                    if (this.isConnected) {
                        this.disconnect();
                        this.connect();
                    }
                });

                document.getElementById('portSelect').addEventListener('change', (e) => {
                    if (this.isConnected) {
                        this.disconnect();
                        this.connect();
                    }
                });

                document.getElementById('testConnection').addEventListener('click', () => {
                    this.testConnection();
                });

                document.getElementById('clearLog').addEventListener('click', () => {
                    this.logger.clear();
                    this.logger.log('Log limpiado', 'info');
                });
            }

            async toggleConnection() {
                if (this.isConnected) {
                    this.disconnect();
                } else {
                    this.connect();
                }
            }

            connect() {
                const interval = parseInt(document.getElementById('updateInterval').value);
                this.isConnected = true;
                document.getElementById('toggleConnection').textContent = 'Desconectar';
                document.getElementById('toggleConnection').classList.replace('btn-primary', 'btn-danger');
                document.getElementById('connectionStatus').classList.replace('status-offline', 'status-online');
                document.getElementById('statusText').textContent = 'Conectado';
                
                this.updateInterval = setInterval(() => this.updateWeight(), interval);
                this.logger.log('Conexión iniciada', 'success');
            }

            disconnect() {
                this.isConnected = false;
                clearInterval(this.updateInterval);
                document.getElementById('toggleConnection').textContent = 'Conectar';
                document.getElementById('toggleConnection').classList.replace('btn-danger', 'btn-primary');
                document.getElementById('connectionStatus').classList.replace('status-online', 'status-offline');
                document.getElementById('statusText').textContent = 'Desconectado';
                document.getElementById('weightDisplay').textContent = '0.00 kg';
                document.getElementById('stabilityBadge').className = 'badge bg-secondary';
                document.getElementById('stabilityBadge').textContent = 'Inestable';
                document.getElementById('validityBadge').className = 'badge bg-secondary';
                document.getElementById('validityBadge').textContent = 'No válido';
                this.logger.log('Conexión terminada');
            }

            async updateWeight() {
                try {
                    const port = document.getElementById('portSelect').value;
                    // Usar la ruta completa al gateway
                    const response = await fetch(`${window.location.origin}/balanceControl/gateway-balanza.php?puerto=${port}`);
                    
                    // Verificar el tipo de contenido de la respuesta
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('El servidor no está respondiendo con JSON. Verifica que el servidor Python local esté ejecutándose.');
                    }

                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        const text = await response.text();
                        console.error('Respuesta no válida:', text);
                        throw new Error('La respuesta del servidor no es JSON válido. Respuesta: ' + text.substring(0, 100));
                    }

                    if (!data.success) {
                        throw new Error(data.error || 'Error al leer la balanza');
                    }

                    // Actualizar display de peso
                    document.getElementById('weightDisplay').textContent = `${data.peso.toFixed(2)} kg`;

                    // Actualizar indicadores
                    const stabilityBadge = document.getElementById('stabilityBadge');
                    stabilityBadge.className = `badge ${data.estado.estable ? 'bg-success' : 'bg-warning'}`;
                    stabilityBadge.textContent = data.estado.estable ? 'Estable' : 'Inestable';

                    const validityBadge = document.getElementById('validityBadge');
                    validityBadge.className = `badge ${!data.estado.sobrecarga ? 'bg-success' : 'bg-danger'}`;
                    validityBadge.textContent = !data.estado.sobrecarga ? 'Válido' : 'Inválido';

                    // Registrar cambios significativos
                    if (this.lastWeight === null || Math.abs(this.lastWeight - data.peso) > 0.1) {
                        this.logger.log(`Nuevo peso: ${data.peso.toFixed(2)} kg (${data.estado.estable ? 'Estable' : 'Inestable'})`, 'success');
                        this.lastWeight = data.peso;
                    }

                } catch (error) {
                    this.logger.log(error.message, 'error');
                    // No desconectamos automáticamente para permitir recuperación de errores temporales
                }
            }
        }

        // Iniciar controlador cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            window.balanceController = new BalanceController();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>